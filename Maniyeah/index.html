<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MANIYEAH - Pro Edition</title>
  <style>
    :root {
      --blue: #1a2a6c;
      --gold: #ffca28;
      --light-blue: #81d4fa;
      --neon-pink: #ff007f;
      --glass: rgba(255, 255, 255, 0.1);
    }
    body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; touch-action: none; }

    /* YENİLENMİŞ ANA MENÜ TASARIMI */
    #menu-overlay, #game-over-overlay {
      position: fixed; width: 100%; height: 100%;
      background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('ana_menu.jpg') no-repeat center center;
      background-size: cover;
      display: flex; justify-content: center; align-items: center; z-index: 10;
    }

    #game-over-overlay { z-index: 20; display: none; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); }

    .selection-box {
      background: rgba(15, 15, 15, 0.75);
      backdrop-filter: blur(25px);
      padding: 40px;
      border-radius: 30px;
      border: 1px solid rgba(255,255,255,0.1);
      text-align: center;
      width: 85%;
      max-width: 700px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5), inset 0 0 20px rgba(255,255,255,0.05);
      max-height: 90vh;
      overflow-y: auto;
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .game-title {
      color: white;
      font-size: 4rem;
      font-weight: 900;
      margin-bottom: 5px;
      letter-spacing: 8px;
      text-transform: uppercase;
      background: linear-gradient(to bottom, #fff, #888);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
    }

    .story-text {
      color: rgba(255,255,255,0.7);
      font-size: 1.1rem;
      margin-bottom: 30px;
      letter-spacing: 1px;
    }

    /* KARAKTER SEÇİMİ YENİ TASARIM */
    .char-title {
      color: var(--gold);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .character-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .char-item {
      background: var(--glass);
      border-radius: 20px;
      padding: 20px 10px;
      cursor: pointer;
      border: 2px solid rgba(255,255,255,0.05);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
    }

    .char-item::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: translateX(-100%); transition: 0.5s;
    }

    .char-item:hover::before { transform: translateX(100%); }

    .char-item:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-5px);
      border-color: rgba(255,255,255,0.3);
    }

    .char-item.selected {
      border-color: var(--gold);
      background: rgba(255, 202, 40, 0.15);
      box-shadow: 0 0 25px rgba(255, 202, 40, 0.3);
      transform: scale(1.05);
    }

    .char-item img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3));
    }

    .char-name {
      font-weight: 700;
      font-size: 0.85rem;
      color: #eee;
      text-transform: uppercase;
      margin-top: 10px;
      letter-spacing: 1px;
    }

    #char-intro {
      color: var(--gold);
      background: rgba(255,255,255,0.05);
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 25px;
      font-style: italic;
      min-height: 20px;
      border-left: 4px solid var(--gold);
      display: none;
      font-size: 0.95rem;
    }

    /* BUTONLAR */
    .btn-play {
      background: white;
      color: black;
      border: none;
      padding: 18px 60px;
      font-size: 1.2rem;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: all 0.3s;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

    .btn-play:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 15px 30px rgba(255,255,255,0.2);
      background: var(--gold);
    }

    .btn-play:disabled {
      background: #333;
      color: #777;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .btn-red { background: #e74c3c; color: white; margin-top: 10px; }
    .btn-share { background: #1da1f2; color: white; }

    /* OYUN UI */
    #game-ui { position: absolute; top: 20px; left: 20px; z-index: 5; display: none; width: calc(100% - 40px); }
    .stats { background: rgba(0,0,0,0.6); color: white; padding: 12px 30px; border-radius: 40px; font-weight: bold; font-size: 1.5rem; border: 2px solid var(--gold); display: inline-block; backdrop-filter: blur(5px); }

    /* KONUŞMA BALONU - ARKA PLAN KALDIRILDI */
    #char-bubble {
      position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
      background: none; padding: 0; font-weight: bold; font-size: 1.5rem;
      color: #000; display: none; z-index: 100;
    }

    #mobile-controls {
      position: fixed; bottom: 30px; left: 0; width: 100%;
      display: none; justify-content: space-between; padding: 0 30px; box-sizing: border-box; z-index: 100;
    }
    .m-btn {
      width: 70px; height: 70px; background: rgba(255,255,255,0.15); border: 2px solid white;
      border-radius: 50%; display: flex; justify-content: center; align-items: center;
      color: white; font-size: 2rem; user-select: none; backdrop-filter: blur(5px);
    }

    .score-container { display: flex; justify-content: space-around; margin: 30px 0; background: rgba(255,255,255,0.05); border-radius: 20px; padding: 25px; }
    .score-label { color: #aaa; font-size: 0.8rem; letter-spacing: 2px; }
    .score-val-end { font-size: 2.5rem; font-weight: bold; color: white; }

    .slow-mo-blur { filter: blur(4px) grayscale(0.3); transition: 0.2s; }
    .speed-blur { filter: blur(2px) contrast(1.2); }
  </style>
</head>
<body>

<audio id="arkaPlanMuzigi" src="muzik.mp3" loop></audio>

<div id="menu-overlay">
  <div class="selection-box">
    <h1 class="game-title">MA-MA-MANIYEAH</h1>
    <p class="story-text">Çok sıkılıp stüdyodan kaçtın. Dikkat! Tolga Bey'e yakalanma!</p>

    <div class="char-title">Bugün hangi Manifest kızısın?</div>
    <div id="char-intro"></div>
    <div class="character-grid" id="char-selector"></div>

    <button id="start-btn" class="btn-play" disabled>OYUNU BAŞLAT</button>
  </div>
</div>

<div id="game-over-overlay">
  <div class="selection-box">
    <div style="color: #e74c3c; font-weight: bold; letter-spacing: 5px; margin-bottom: 10px;">EYVAH! YAKALANDIN</div>
    <h1 class="game-title" style="font-size: 3rem;">OYUN BİTTİ</h1>
    <div class="score-container">
      <div class="score-item">
        <div class="score-label">EN YÜKSEK</div>
        <div class="score-val-end" id="high-score-val" style="color: var(--gold);">0</div>
      </div>
      <div class="score-item">
        <div class="score-label">SKORUN</div>
        <div class="score-val-end" id="final-score-val">0</div>
      </div>
    </div>
    <div id="end-char-display" style="margin-bottom: 30px;"></div>
    <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
      <button onclick="restartGame()" class="btn-play">TEKRAR DENE</button>
      <button onclick="location.reload()" class="btn-play btn-red" style="padding: 18px 30px;">ANA MENÜ</button>
    </div>
  </div>
</div>

<div id="game-ui">
  <div class="stats" id="main-stats">⭐️ <span id="score-val">0</span></div>
  <div id="char-bubble"></div>
</div>

<div id="mobile-controls">
  <div style="display: flex; gap: 20px;">
    <div class="m-btn" id="m-left">←</div>
    <div class="m-btn" id="m-right">→</div>
  </div>
  <div class="m-btn" id="m-jump">↑</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playSound(id) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    if (id === 'sndJump') {
      const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.type = 'square'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
      osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }
    if (id === 'sndStar') {
      const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.type = 'triangle'; osc.frequency.setValueAtTime(800, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
      osc.start(); osc.stop(audioCtx.currentTime + 0.15);
    }
    if (id === 'sndGameOver') {
      const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.type = 'sawtooth'; osc.frequency.setValueAtTime(300, audioCtx.currentTime);
      osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.5);
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
      osc.start(); osc.stop(audioCtx.currentTime + 0.5);
    }
  }

  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const bgMusic = document.getElementById('arkaPlanMuzigi');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const bgColors = {
    "zoktay": { top: "#000428", bottom: "#004e92" },
    "hilal":  { top: "#240b36", bottom: "#6c3483" },
    "sueda":  { top: "#0d2a0d", bottom: "#2d5a27" },
    "esin":   { top: "#f7971e", bottom: "#ffd200" },
    "mina":   { top: "#4b0000", bottom: "#a00000" },
    "lidya":  { top: "#db7093", bottom: "#ffb6c1" }
  };
  const charDetails = {
    "zoktay": { intro: "\"Hocam, dövim mi?\"", quotes: ["Çat kapı gelirim aklına oğlum", "Sana alkış yok anca parmak şıklatması", "Dur! Sıkılmadım reddetmekten! Seni çok üzdüysem devam edicem", "Nerdesin Pango?"] },
    "esin": { intro: "\"Teşekkürler! TEŞEKKÜRLER!\"", quotes: ["Patlar TNT şarkılar on the radio", "Ortada mı kaldın, pardon?", "Sardık mı en başa düşmem o tuzağa (Düştü)"] },
    "mina": { intro: "\"Amin inşallah...\"", quotes: ["Yalnız hissettiğimde hatırlatanlarım var.", "Camera flash on manifest", "Sınırları, kuralları yıktım kanatlarımla"] },
    "lidya": { intro: "\"İkisi de vampir bu arada. Dokunma bana!\"", quotes: ["Yanıma renk renk çiçeklerle gelsen de", "Sanıyor ki herkes ona hayran", "Bir kere de sabret! Yaptığın her şey yanlış!"] },
    "hilal": { intro: "\"Harbiyeah! Gramyeahh!\"", quotes: ["Taktik maktik, işlemez yok", "İtsen de ben yere düşmem", "İçim ürperiyoo beni deli ediyoo"] },
    "sueda": { intro: "\"Benim en sevdiğim renk mordur, erkekler benim için mavi.\"", quotes: ["Normale göre hayat biraz hızlı gidiyo", "Gözümü kapatınca neden hep önümdesin?", "Dudaklarıma focus, acaba ne diyo?"] }
  };

  const names = Object.keys(charDetails);
  let selectedChar = "";
  let gameRunning = false;
  let score = 0;
  let cameraX = 0;
  let lastGeneratedX = 1500;
  let shakeTime = 0;
  let slowMo = false;
  let quoteInterval;
  let zoomLevel = 1;
  let fireworks = [];
  const images = {};
  const keys = {};

  // KARAKTER RENK TANIMLAMALARI
  const textColors = {
    "zoktay": "#1e90ff", // Mavi
    "mina": "#ff4d4d",   // Kırmızı
    "sueda": "#2ecc71",  // Yeşil
    "esin": "#ffca28",   // Sarı
    "lidya": "#ff69b4",  // Pembe
    "hilal": "#a020f0"   // Mor
  };

  const selector = document.getElementById('char-selector');
  names.forEach(n => {
    const div = document.createElement('div');
    div.className = 'char-item';
    div.innerHTML = `<img src="${n}duran.png"><div class="char-name">${n}</div>`;
    div.onclick = () => {
      document.querySelectorAll('.char-item').forEach(i => i.classList.remove('selected'));
      div.classList.add('selected');
      selectedChar = n;
      document.getElementById('start-btn').disabled = false;
      const introDiv = document.getElementById('char-intro');
      introDiv.innerText = charDetails[n].intro;
      introDiv.style.display = 'block';
      // Renkleri burada uyguluyoruz
      introDiv.style.color = textColors[n];
      introDiv.style.borderColor = textColors[n];
    };
    selector.appendChild(div);
  });

  function loadAssets(name) {
    images.idle = new Image(); images.idle.src = `${name}duran.png`;
    images.walk = new Image(); images.walk.src = `${name}yuruyen.png`;
    images.jump = new Image(); images.jump.src = `${name}ziplayan.png`;
    images.star = new Image(); images.star.src = 'yildiz.png';
    images.enemy = new Image(); images.enemy.src = 'dusman.png';
    images.p_shield = new Image(); images.p_shield.src = 'shield.png';
    images.p_speed = new Image(); images.p_speed.src = 'speed.png';
    images.p_gravity = new Image(); images.p_gravity.src = 'gravity.png';
    images.bgSunset = new Image(); images.bgSunset.src = 'gun.png';
    images.bgCave = new Image(); images.bgCave.src = 'magra.png';
    images.bgMystery = new Image(); images.bgMystery.src = 'gizem.png';
    images.bgVolcano = new Image(); images.bgVolcano.src = 'yanardag.png';
  }

  let platforms = [], stars = [], enemies = [], powerups = [];

  function initWorld() {
    score = 0; cameraX = 0; lastGeneratedX = 1500; zoomLevel = 1;
    platforms = [{x: 0, y: canvas.height - 120, w: 1500, h: 400}];
    stars = []; enemies = []; powerups = []; fireworks = [];
    hero.x = 250; hero.y = canvas.height - 500;
    hero.vY = 0; hero.vX = 0; hero.resetBuffs();
    document.getElementById('score-val').innerText = "0";
    bgMusic.playbackRate = 1.0;
    bgMusic.play().catch(()=>{});
    startQuoteTimer();
  }

  function startQuoteTimer() {
    clearInterval(quoteInterval);
    quoteInterval = setInterval(() => {
      if(!gameRunning) return;
      const bubble = document.getElementById('char-bubble');
      const q = charDetails[selectedChar].quotes;
      bubble.innerText = q[Math.floor(Math.random()*q.length)];
      bubble.style.display = 'block';
      setTimeout(() => { if(gameRunning) bubble.style.display = 'none'; }, 2500);
    }, 8000);
  }

  function generateWorld() {
    while (lastGeneratedX < hero.x + canvas.width + 1000) {
      let gap = 160 + Math.random() * 140;
      let width = 600 + Math.random() * 800;
      let y = canvas.height - 120 - (Math.random() * 250);
      let platX = lastGeneratedX + gap;
      platforms.push({x: platX, y: y, w: width, h: 500});
      let isRisky = Math.random() > 0.8;
      let starY = isRisky ? y - 250 : y - 70;
      stars.push({x: platX + 150, y: starY, w: 50, h: 50, collected: false, risky: isRisky});
      if(Math.random() > 0.88) {
        const types = ['shield', 'speed', 'gravity'];
        powerups.push({ x: platX + width/2, y: y - 80, w: 40, h: 40, type: types[Math.floor(Math.random()*3)], collected: false });
      }
      if(Math.random() > 0.5) {
        let eSize = 160 + Math.random() * 60;
        let baseSpeed = 4 + (score/200);
        enemies.push({ x: platX + 50, y: y - eSize + 20, w: eSize, h: eSize, startX: platX + 50, range: width - eSize - 100, speed: baseSpeed + Math.random() * 2, dir: 1 });
      }
      lastGeneratedX += gap + width;
    }
  }

  class Player {
    constructor() {
      this.resetBuffs();
      this.x = 250; this.y = canvas.height - 500;
      this.w = 115; this.h = 135;
      this.vX = 0; this.vY = 0;
      this.speed = 8.5; this.jumpPower = -23;
      this.gravity = 0.95;
      this.grounded = false;
      this.facingRight = false;
    }
    resetBuffs() { this.buffs = { shield: 0, speed: 0, gravity: 0 }; }
    update() {
      let currentSpeed = this.speed;
      let currentJump = this.jumpPower;
      let currentGrav = this.gravity;
      if(this.buffs.speed > 0) { currentSpeed *= 1.6; this.buffs.speed--; canvas.classList.add('speed-blur'); }
      else { canvas.classList.remove('speed-blur'); }
      if(this.buffs.gravity > 0) { currentGrav *= 0.5; currentJump = -25; this.buffs.gravity--; }
      if(this.buffs.shield > 0) this.buffs.shield--;

      if (keys['ArrowRight'] || keys['MobileRight']) { this.vX = currentSpeed; this.facingRight = true; }
      else if (keys['ArrowLeft'] || keys['MobileLeft']) { this.vX = -currentSpeed; this.facingRight = false; }
      else { this.vX *= 0.8; }
      if ((keys['Space'] || keys['ArrowUp'] || keys['MobileJump']) && this.grounded) {
        this.vY = currentJump; this.grounded = false; playSound('sndJump');
      }
      this.vY += currentGrav; this.x += this.vX; this.y += this.vY;
      if(this.vY < -10) zoomLevel = Math.max(0.85, zoomLevel - 0.005);
      else zoomLevel = Math.min(1, zoomLevel + 0.01);
      let onPlatform = false;
      platforms.forEach(p => {
        if (this.x + 50 < p.x + p.w && this.x + this.w - 50 > p.x) {
          let playerFeet = this.y + this.h - 20;
          if (playerFeet >= p.y && playerFeet <= p.y + 35 + Math.abs(this.vY)) {
            this.y = p.y - this.h + 20; this.vY = 0; onPlatform = true;
          }
        }
      });
      this.grounded = onPlatform;
      if (this.y > canvas.height + 200) gameOver();
      cameraX = this.x - (250 / zoomLevel);
    }
    draw() {
      ctx.save();
      if(this.buffs.shield > 0) {
        ctx.beginPath(); ctx.arc(this.x - cameraX + this.w/2, this.y + this.h/2, 80, 0, Math.PI*2);
        ctx.strokeStyle = '#00fbff'; ctx.lineWidth = 5; ctx.stroke();
      }
      let img = this.grounded ? (Math.abs(this.vX) > 0.5 ? images.walk : images.idle) : images.jump;
      if (this.facingRight) { ctx.translate(this.x + this.w - cameraX, this.y); ctx.scale(-1, 1); ctx.drawImage(img, 0, 0, this.w, this.h); }
      else { ctx.drawImage(img, this.x - cameraX, this.y, this.w, this.h); }
      ctx.restore();
    }
  }

  const hero = new Player();

  function gameLoop() {
    if (!gameRunning) return;
    if(slowMo) { setTimeout(() => requestAnimationFrame(gameLoop), 50); document.body.classList.add('slow-mo-blur'); }
    else { requestAnimationFrame(gameLoop); }
    ctx.save();
    ctx.scale(zoomLevel, zoomLevel);
    if(shakeTime > 0) { ctx.translate(Math.random()*8-4, Math.random()*8-4); shakeTime--; }
    ctx.clearRect(0, 0, canvas.width/zoomLevel, canvas.height/zoomLevel);

    if (score >= 400) { if (images.bgVolcano.complete) ctx.drawImage(images.bgVolcano, 0, 0, canvas.width/zoomLevel, canvas.height/zoomLevel); else { ctx.fillStyle = "#4a0000"; ctx.fillRect(0, 0, canvas.width/zoomLevel, canvas.height/zoomLevel); } }
    else if (score >= 300) { if (images.bgMystery.complete) ctx.drawImage(images.bgMystery, 0, 0, canvas.width/zoomLevel, canvas.height/zoomLevel); else { ctx.fillStyle = "#0a2f2f"; ctx.fillRect(0, 0, canvas.width/zoomLevel, canvas.height/zoomLevel); } }
    else if (score >= 200) { if (images.bgCave.complete) ctx.drawImage(images.bgCave, 0, 0, canvas.width/zoomLevel, canvas.height/zoomLevel); else { ctx.fillStyle = "#1e272e"; ctx.fillRect(0, 0, canvas.width/zoomLevel, canvas.height/zoomLevel); } }
    else if (score >= 100) { if (images.bgSunset.complete) ctx.drawImage(images.bgSunset, 0, 0, canvas.width/zoomLevel, canvas.height/zoomLevel); else { ctx.fillStyle = "#ff7e5f"; ctx.fillRect(0, 0, canvas.width/zoomLevel, canvas.height/zoomLevel); } }
    else {
      let colors = bgColors[selectedChar] || bgColors["zoktay"];
      let grad = ctx.createLinearGradient(0, 0, 0, canvas.height/zoomLevel);
      grad.addColorStop(0, colors.top); grad.addColorStop(1, colors.bottom);
      ctx.fillStyle = grad; ctx.fillRect(0, 0, canvas.width/zoomLevel, canvas.height/zoomLevel);
    }

    generateWorld();
    hero.update();
    platforms.forEach(p => {
      ctx.fillStyle = "#1e272e"; ctx.fillRect(p.x - cameraX, p.y, p.w, p.h);
      ctx.fillStyle = varColor(); ctx.fillRect(p.x - cameraX, p.y, p.w, 4);
    });

    function varColor() {
      if(score >= 400) return "#ff4500";
      if(score >= 300) return "#32ff7e";
      if(score >= 100) return "#e67e22";
      return "#00d2ff";
    }

    stars.forEach(s => {
      if (!s.collected) {
        if(s.risky) { ctx.shadowBlur = 15; ctx.shadowColor = "gold"; }
        ctx.drawImage(images.star, s.x - cameraX, s.y, s.w, s.h);
        ctx.shadowBlur = 0;
        if (preciseCollide(hero, s, 0.1)) {
          s.collected = true; score += 10;
          document.getElementById('score-val').innerText = score;
          playSound('sndStar'); shakeTime = 5;
        }
      }
    });

    powerups.forEach(p => {
      if (!p.collected) {
        ctx.drawImage(images['p_'+p.type], p.x - cameraX, p.y, p.w, p.h);
        if (preciseCollide(hero, p, 0.1)) { p.collected = true; hero.buffs[p.type] = 300; }
      }
    });

    enemies.forEach(e => {
      e.x += e.speed * e.dir;
      if (e.x > e.startX + e.range || e.x < e.startX) e.dir *= -1;
      ctx.save();
      if (e.dir === 1) ctx.drawImage(images.enemy, e.x - cameraX, e.y, e.w, e.h);
      else { ctx.translate(e.x + e.w - cameraX, e.y); ctx.scale(-1, 1); ctx.drawImage(images.enemy, 0, 0, e.w, e.h); }
      ctx.restore();
      if (preciseCollide(hero, e, 0.4)) {
        if(hero.buffs.shield > 0) { hero.buffs.shield = 0; e.x = -2000; }
        else { slowMo = true; setTimeout(gameOver, 600); }
      }
    });
    hero.draw(); ctx.restore();
  }

  function preciseCollide(a, b, pad) {
    let pW = a.w * pad, pH = a.h * pad;
    return a.x + pW < b.x + b.w - pW && a.x + a.w - pW > b.x + pW && a.y + pH < b.y + b.h - pH && a.y + a.h - pH > b.y + pH;
  }

  function gameOver() {
    if(!gameRunning && !slowMo) return;
    gameRunning = false; slowMo = false;
    canvas.classList.remove('speed-blur');
    document.body.classList.remove('slow-mo-blur');
    document.getElementById('char-bubble').style.display = 'none';
    playSound('sndGameOver'); bgMusic.pause();
    let highScore = localStorage.getItem('maniyeah_rekor') || 0;
    if (score > highScore) { highScore = score; localStorage.setItem('maniyeah_rekor', highScore); }
    document.getElementById('high-score-val').innerText = highScore;
    document.getElementById('final-score-val').innerText = score;
    document.getElementById('end-char-display').innerHTML = `<div class="char-item selected" style="margin:auto; cursor:default; background:rgba(255,255,255,0.1);"><img src="${selectedChar}duran.png"><div class="char-name">${selectedChar}</div></div>`;
    document.getElementById('game-ui').style.display = 'none';
    document.getElementById('game-over-overlay').style.display = 'flex';
    document.getElementById('mobile-controls').style.display = 'none';
  }

  function restartGame() {
    document.getElementById('game-over-overlay').style.display = 'none';
    document.getElementById('game-ui').style.display = 'block';
    if ('ontouchstart' in window) document.getElementById('mobile-controls').style.display = 'flex';
    initWorld(); gameRunning = true; gameLoop();
  }

  document.getElementById('start-btn').onclick = () => {
    loadAssets(selectedChar);
    document.getElementById('menu-overlay').style.display = 'none';
    document.getElementById('game-ui').style.display = 'block';
    if ('ontouchstart' in window) document.getElementById('mobile-controls').style.display = 'flex';
    initWorld(); gameRunning = true; gameLoop();
  };

  window.addEventListener('keydown', e => keys[e.code] = true);
  window.addEventListener('keyup', e => keys[e.code] = false);
  const mBtn = (id, key) => {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; if(key==='MobileJump') playSound('sndJump'); });
    el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
  };
  mBtn('m-left', 'MobileLeft'); mBtn('m-right', 'MobileRight'); mBtn('m-jump', 'MobileJump');
  window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
</script>
</body>
</html>
