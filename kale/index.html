<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PIXEL DEFENSE: NEON WARFARE</title>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #00f3ff;
      --danger: #ff0055;
      --gold: #ffd700;
      --bg: #050505;
    }

    body {
      margin: 0;
      overflow: hidden;
      background-color: var(--bg);
      font-family: 'Rajdhani', sans-serif;
      color: white;
      user-select: none;
    }

    /* Dinamik Arka Plan */
    #bg-grid {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-image:
              linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px),
              linear-gradient(90deg, rgba(0, 243, 255, 0.1) 1px, transparent 1px);
      background-size: 50px 50px;
      background-position: center;
      transform: perspective(500px) rotateX(60deg) scale(2);
      transform-origin: center top;
      z-index: -1;
      animation: gridMove 20s linear infinite;
      opacity: 0.3;
    }

    @keyframes gridMove {
      from { background-position: 0 0; }
      to { background-position: 0 50px; }
    }

    #gameCanvas {
      display: block;
      cursor: crosshair;
    }

    /* UI Katmanı */
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; padding: 20px; box-sizing: border-box;
      display: flex; flex-direction: column; justify-content: space-between;
    }

    /* Üst Bilgi Paneli */
    .hud-top {
      display: flex; gap: 30px;
      font-size: 24px; font-weight: bold; text-transform: uppercase;
      background: rgba(0,0,0,0.6);
      padding: 15px 30px;
      border-radius: 0 0 20px 20px;
      border-bottom: 2px solid var(--primary);
      backdrop-filter: blur(5px);
      align-self: center;
      box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
    }

    .stat-box span { font-size: 28px; margin-left: 5px; text-shadow: 0 0 10px currentColor; }

    /* Alt Silah Barı */
    .hud-bottom {
      align-self: center;
      display: flex; gap: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 20px;
      border-radius: 15px;
      border: 1px solid #333;
      pointer-events: auto;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .weapon-slot {
      width: 70px; height: 80px;
      border: 1px solid #444;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      cursor: pointer; transition: 0.3s;
      position: relative;
      background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
      border-radius: 8px;
      overflow: hidden;
    }

    .weapon-slot:hover { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); }

    .weapon-slot.active {
      border-color: var(--primary);
      background: linear-gradient(180deg, #003333 0%, #001111 100%);
      transform: translateY(-10px);
      box-shadow: 0 0 20px var(--primary);
    }

    .weapon-slot.locked { opacity: 0.4; filter: grayscale(1); cursor: not-allowed; }

    .key-hint {
      position: absolute; top: 5px; left: 5px;
      font-size: 10px; color: #666; font-weight: bold;
    }

    .w-name { font-size: 12px; font-weight: bold; margin-top: 10px; color: #eee; }
    .cost { font-size: 12px; color: var(--gold); font-weight: bold; margin-top: 2px; }

    /* Game Over Ekranı */
    #game-over-screen {
      position: absolute; inset: 0;
      background: rgba(5, 5, 5, 0.95);
      display: none; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 100; pointer-events: auto;
      backdrop-filter: blur(10px);
      text-align: center;
    }

    button {
      background: transparent; color: var(--primary);
      border: 2px solid var(--primary);
      padding: 15px 50px;
      font-family: inherit; font-size: 24px; font-weight: bold;
      cursor: pointer; margin-top: 30px;
      text-transform: uppercase; letter-spacing: 2px;
      transition: 0.3s;
      box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
    }
    button:hover { background: var(--primary); color: black; box-shadow: 0 0 40px var(--primary); }

    /* CRT Overlay (Vignette) */
    .vignette {
      position: fixed; inset: 0; pointer-events: none;
      background: radial-gradient(circle, transparent 50%, black 120%);
      z-index: 90;
    }
  </style>
</head>
<body>

<div id="bg-grid"></div>
<div class="vignette"></div>

<div id="ui-layer">
  <div class="hud-top">
    <div class="stat-box" style="color:var(--danger)">HP <span id="hp-display">100</span>%</div>
    <div class="stat-box" style="color:white">WAVE <span id="wave-display">1</span></div>
    <div class="stat-box" style="color:var(--gold)">$ <span id="money-display">0</span></div>
  </div>

  <div class="hud-bottom" id="weapon-bar">
  </div>
</div>

<div id="game-over-screen">
  <h1 style="color:var(--danger); font-size: 60px; margin:0; text-shadow: 0 0 30px var(--danger); line-height: 1.2;">KALE ÇÖKTÜ!<br>GAME OVER</h1>

  <p style="font-size: 24px; color:#aaa; margin-top: 20px;">SKOR: <span id="final-score" style="color:white">0</span></p>
  <p style="font-size: 20px; color:var(--gold); margin-top: 5px;">EN YÜKSEK SKOR: <span id="high-score">0</span></p>

  <button onclick="location.reload()">SİSTEMİ YENİLE</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
  // --- SES MOTORU ---
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function playSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    const now = audioCtx.currentTime;

    if (type === 'shoot') {
      osc.frequency.setValueAtTime(600, now);
      osc.frequency.exponentialRampToValueAtTime(100, now + 0.15);
      gain.gain.setValueAtTime(0.1, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
      osc.start(now); osc.stop(now + 0.15);
    } else if (type === 'explosion') {
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(100, now);
      osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.5);
      gain.gain.setValueAtTime(0.2, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
      osc.start(now); osc.stop(now + 0.5);
    }
  }

  // --- OYUN DEĞİŞKENLERİ ---
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  let gameActive = true;
  let score = 0, money = 0, bunkerHealth = 100, wave = 1, frame = 0;
  let screenShake = 0; // Ekran titreme değeri

  // --- SİLAHLAR (FİYATLAR DÜŞÜRÜLDÜ) ---
  const weapons = [
    { id: 0, name: "PISTOL", cost: 0, damage: 25, speed: 18, cooldown: 25, color: "#ffeb3b", type: "bullet", unlocked: true },
    { id: 1, name: "SMG", cost: 250, damage: 15, speed: 22, cooldown: 6, color: "#00f3ff", type: "bullet", unlocked: false },
    { id: 2, name: "SHOTGUN", cost: 500, damage: 18, speed: 15, cooldown: 45, color: "#ff5722", type: "shotgun", count: 6, unlocked: false },
    { id: 3, name: "LASER", cost: 1000, damage: 300, speed: 40, cooldown: 70, color: "#e91e63", type: "piercing", unlocked: false },
    { id: 4, name: "NUKE", cost: 3000, damage: 1000, speed: 0, cooldown: 400, color: "#ff0000", type: "airstrike", unlocked: false }
  ];
  let currentWeaponId = 0;
  let lastShotTime = 0;

  // --- OYUNCU ---
  const player = {
    x: canvas.width / 2,
    y: canvas.height - 60,
    angle: 0,
    recoil: 0 // Geri tepme efekti için
  };

  const projectiles = [];
  const enemies = [];
  const particles = [];

  // --- SINIFLAR ---
  class Projectile {
    constructor(x, y, angle, weapon) {
      this.x = x; this.y = y;
      this.vx = Math.cos(angle) * weapon.speed;
      this.vy = Math.sin(angle) * weapon.speed;
      this.damage = weapon.damage;
      this.color = weapon.color;
      this.type = weapon.type;
      this.radius = 3;
      // İz bırakmak için eski pozisyonları tut
      this.trail = [];
    }

    update() {
      this.trail.push({x: this.x, y: this.y});
      if(this.trail.length > 5) this.trail.shift();

      this.x += this.vx;
      this.y += this.vy;
      return (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height);
    }

    draw() {
      ctx.shadowBlur = 10;
      ctx.shadowColor = this.color;
      ctx.fillStyle = this.color;

      // Mermi
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
      ctx.fill();

      // İz (Trail)
      ctx.beginPath();
      ctx.strokeStyle = this.color;
      ctx.lineWidth = 2;
      if (this.trail.length > 0) {
        ctx.moveTo(this.trail[0].x, this.trail[0].y);
        for(let p of this.trail) ctx.lineTo(p.x, p.y);
        ctx.stroke();
      }

      ctx.shadowBlur = 0; // Reset
    }
  }

  class Enemy {
    constructor(type) {
      this.type = type;
      this.x = Math.random() * canvas.width;
      this.y = -50;
      this.angle = Math.atan2(player.y - this.y, player.x - this.x);

      // Düşman özelliklerini ayarla
      if (type === 'tank') {
        this.speed = 0.4; this.maxHp = 300 + (wave*30); this.radius = 25; this.money = 100; this.color = '#ff0055';
      } else if (type === 'runner') {
        this.speed = 3 + Math.random(); this.maxHp = 20 + (wave*3); this.radius = 10; this.money = 25; this.color = '#ffcc00';
      } else {
        this.speed = 1 + Math.random(); this.maxHp = 50 + (wave*8); this.radius = 15; this.money = 15; this.color = '#ff4444';
      }
      this.hp = this.maxHp;
    }

    update() {
      this.x += Math.cos(this.angle) * this.speed;
      this.y += Math.sin(this.angle) * this.speed;

      const dist = Math.hypot(player.x - this.x, player.y - this.y);
      if (dist < 60) {
        bunkerHealth -= 10;
        screenShake = 10; // Çarpma sarsıntısı
        playSound('explosion');
        createParticles(this.x, this.y, 10, this.color);
        return true;
      }
      return false;
    }

    draw() {
      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.rotate(this.angle - Math.PI/2);

      ctx.shadowBlur = 15;
      ctx.shadowColor = this.color;
      ctx.strokeStyle = this.color;
      ctx.lineWidth = 2;
      ctx.fillStyle = 'rgba(0,0,0,0.5)';

      // Şekil Çizimi
      ctx.beginPath();
      if(this.type === 'tank') {
        ctx.rect(-20, -20, 40, 40); // Kare
      } else if (this.type === 'runner') {
        ctx.moveTo(0, 15); ctx.lineTo(10, -10); ctx.lineTo(-10, -10); ctx.closePath(); // Üçgen
      } else {
        ctx.moveTo(0, 15); ctx.lineTo(15, 0); ctx.lineTo(0, -15); ctx.lineTo(-15, 0); ctx.closePath(); // Baklava
      }
      ctx.fill();
      ctx.stroke();

      // Can Barı (Sadece hasar aldıysa göster)
      if(this.hp < this.maxHp) {
        ctx.shadowBlur = 0;
        ctx.fillStyle = 'red';
        ctx.fillRect(-15, -30, 30, 4);
        ctx.fillStyle = '#0f0';
        ctx.fillRect(-15, -30, 30 * (this.hp / this.maxHp), 4);
      }

      ctx.restore();
    }

    takeDamage(amount) {
      this.hp -= amount;
      if (this.hp <= 0) {
        money += this.money;
        score += this.money;
        screenShake = 2; // Öldürme sarsıntısı
        createParticles(this.x, this.y, 15, this.color);
        playSound('explosion');
        updateUI();
        return true;
      }
      return false;
    }
  }

  class Particle {
    constructor(x, y, color) {
      this.x = x; this.y = y;
      const angle = Math.random() * Math.PI * 2;
      const speed = Math.random() * 5;
      this.vx = Math.cos(angle) * speed;
      this.vy = Math.sin(angle) * speed;
      this.life = 1;
      this.decay = Math.random() * 0.03 + 0.01;
      this.color = color;
    }
    update() {
      this.x += this.vx; this.y += this.vy;
      this.life -= this.decay;
      return this.life <= 0;
    }
    draw() {
      ctx.globalAlpha = this.life;
      ctx.fillStyle = this.color;
      ctx.fillRect(this.x, this.y, 3, 3);
      ctx.globalAlpha = 1;
    }
  }

  function createParticles(x, y, count, color) {
    for(let i=0; i<count; i++) particles.push(new Particle(x, y, color));
  }

  // --- OYUN DÖNGÜSÜ ---
  function spawnEnemies() {
    if (frame % (100 - Math.min(80, wave * 3)) === 0) {
      let type = 'basic';
      if (wave > 2 && Math.random() < 0.3) type = 'runner';
      if (wave > 4 && Math.random() < 0.15) type = 'tank';
      enemies.push(new Enemy(type));
    }
    if (frame % 1000 === 0) { wave++; updateUI(); }
  }

  function drawPlayer() {
    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.rotate(player.angle);

    // Recoil (Geri tepme)
    const kick = player.recoil;

    // Namlu (Glow efektli)
    ctx.shadowBlur = 20;
    ctx.shadowColor = weapons[currentWeaponId].color;
    ctx.fillStyle = weapons[currentWeaponId].color;
    ctx.fillRect(10 - kick, -4, 40, 8); // Namlu

    // Gövde (Teknolojik daire)
    ctx.shadowBlur = 10;
    ctx.shadowColor = '#00f3ff';
    ctx.fillStyle = '#111';
    ctx.strokeStyle = '#00f3ff';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(0, 0, 25, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();

    // Merkez Detay
    ctx.fillStyle = '#00f3ff';
    ctx.beginPath();
    ctx.arc(0, 0, 8, 0, Math.PI*2);
    ctx.fill();

    ctx.restore();
  }

  function update() {
    if (!gameActive) return;
    frame++;

    // Ekran Temizle & Sarsıntı Uygula
    ctx.save();
    if (screenShake > 0) {
      const dx = (Math.random() - 0.5) * screenShake;
      const dy = (Math.random() - 0.5) * screenShake;
      ctx.translate(dx, dy);
      screenShake *= 0.9; // Sarsıntı azalarak biter
      if(screenShake < 0.5) screenShake = 0;
    }
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Ateş Etme
    if (mouseDown && frame - lastShotTime > weapons[currentWeaponId].cooldown) {
      const w = weapons[currentWeaponId];
      player.recoil = 10; // Geri tepme ayarla
      screenShake = 2; // Hafif sarsıntı

      if (w.type === 'airstrike') {
        enemies.forEach(e => e.takeDamage(1000));
        createParticles(canvas.width/2, canvas.height/2, 200, 'white');
        screenShake = 20;
        playSound('explosion');
      } else if (w.type === 'shotgun') {
        for(let i=0; i<w.count; i++) {
          let spread = (Math.random() - 0.5) * 0.4;
          projectiles.push(new Projectile(player.x, player.y, player.angle + spread, w));
        }
        playSound('shoot');
      } else {
        projectiles.push(new Projectile(player.x, player.y, player.angle, w));
        playSound('shoot');
      }
      lastShotTime = frame;
    }

    // Recoil iyileşmesi
    if(player.recoil > 0) player.recoil *= 0.8;

    // Varlık Güncellemeleri
    for (let i = projectiles.length - 1; i >= 0; i--) {
      const p = projectiles[i];
      if (p.update()) { projectiles.splice(i, 1); continue; }
      p.draw();

      for (let j = enemies.length - 1; j >= 0; j--) {
        const e = enemies[j];
        const dist = Math.hypot(p.x - e.x, p.y - e.y);
        if (dist < e.radius + p.radius + 10) {
          const dead = e.takeDamage(p.damage);
          if (dead) enemies.splice(j, 1);
          if (p.type !== 'piercing') { projectiles.splice(i, 1); break; }
        }
      }
    }

    spawnEnemies();
    for (let i = enemies.length - 1; i >= 0; i--) {
      const e = enemies[i];
      if (e.update()) {
        enemies.splice(i, 1);
        updateUI();
        if (bunkerHealth <= 0) {
          gameActive = false;
          // High Score Kaydetme
          let highScore = localStorage.getItem('pixelDefenseHighScore') || 0;
          if (score > highScore) {
            highScore = score;
            localStorage.setItem('pixelDefenseHighScore', highScore);
          }
          document.getElementById('high-score').innerText = highScore;

          document.getElementById('game-over-screen').style.display = 'flex';
          document.getElementById('final-score').innerText = score;
        }
      }
      e.draw();
    }

    for (let i = particles.length - 1; i >= 0; i--) {
      if (particles[i].update()) particles.splice(i, 1); else particles[i].draw();
    }

    drawPlayer();
    ctx.restore(); // Sarsıntı reset
    requestAnimationFrame(update);
  }

  // --- UI ---
  function initUI() {
    const bar = document.getElementById('weapon-bar');
    bar.innerHTML = '';
    weapons.forEach((w, index) => {
      const slot = document.createElement('div');
      slot.className = `weapon-slot ${w.unlocked ? '' : 'locked'} ${index === currentWeaponId ? 'active' : ''}`;
      slot.onclick = () => {
        if (!w.unlocked && money >= w.cost) {
          money -= w.cost;
          w.unlocked = true;
          playSound('shoot');
        }
        if (w.unlocked) {
          currentWeaponId = index;
          initUI();
        }
      };
      slot.innerHTML = `
                <div class="key-hint">${index + 1}</div>
                <div class="w-name" style="color:${w.color}">${w.name}</div>
                ${!w.unlocked ? `<div class="cost">$${w.cost}</div>` : ''}
            `;
      bar.appendChild(slot);
    });
    updateUI();
  }

  function updateUI() {
    document.getElementById('hp-display').innerText = Math.max(0, bunkerHealth);
    document.getElementById('money-display').innerText = money;
    document.getElementById('wave-display').innerText = wave;
  }

  // --- INPUT ---
  let mouseDown = false;
  window.addEventListener('mousemove', e => player.angle = Math.atan2(e.clientY - player.y, e.clientX - player.x));
  window.addEventListener('mousedown', () => mouseDown = true);
  window.addEventListener('mouseup', () => mouseDown = false);
  window.addEventListener('keydown', e => {
    const key = parseInt(e.key);
    if (key >= 1 && key <= weapons.length) {
      if(weapons[key-1].unlocked) { currentWeaponId = key - 1; initUI(); }
    }
  });

  initUI();
  requestAnimationFrame(update);

</script>
</body>
</html>